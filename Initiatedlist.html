<head>
  <meta charset="UTF-8" />
  <title>Perth Initiated Devotee List</title>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <!-- SheetJS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>

	/* Narrower Country column */
#devoteeTable th:nth-child(16),
#devoteeTable td:nth-child(16) {
  max-width: 80px;
  width: 80px;
}
/* Diksha Guru column half width */
#devoteeTable th:nth-child(24),
#devoteeTable td:nth-child(24) {
  max-width: 90px;
  width: 90px;
}


    body {
      margin: 0;
      font-family: "Segoe UI", sans-serif;
      background-image: url('https://iskconnewtown.com/wp-content/uploads/2024/02/nitai-gauranga-iskconnewtown-kolkata-6.jpeg');
      background-repeat: no-repeat;
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
    }

    header {
      background: rgba(0,0,0,0.7);
      color: #fff;
      padding: 15px 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .view-switch button {
      padding: 10px 20px;
      border: none;
      border-radius: 25px;
      cursor: pointer;
      font-weight: 600;
      background: #f6e58d;
      margin-left: 8px;
    }

    .view-switch button.active {
      background: #e17055;
      color: #fff;
    }

    main { padding: 25px; }

    .card {
      background: rgba(255,255,255,0.92);
      border-radius: 14px;
      padding: 22px;
      max-width: 1100px;
      margin: 0 auto;
    }

    .card#adminView {
      max-width: 100%;
      width: 100%;
    }

    .hidden { display: none; }

    .form-section-title {
      font-size: 18px;
      margin-top: 20px;
      margin-bottom: 8px;
      font-weight: 700;
      color: #e67e22;
    }

    .form-row {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      margin-bottom: 10px;
    }

    .form-group {
      flex: 1 1 260px;
      display: flex;
      flex-direction: column;
    }

    input, select {
      padding: 7px 9px;
      border-radius: 6px;
      border: 1px solid #b2bec3;
      background: #fffdf8;
    }

    .submit-row {
      margin-top: 20px;
      text-align: right;
    }

    .submit-row button {
      padding: 9px 18px;
      border-radius: 20px;
      border: none;
      background: #e17055;
      color: white;
      font-size: 14px;
      cursor: pointer;
      font-weight: 600;
      margin-left: 8px;
    }

    .error {
      color: red;
      font-size: 12px;
      margin-top: 3px;
    }

    .admin-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 12px;
    }

    .admin-controls button {
      padding: 7px 14px;
      border-radius: 18px;
      border: none;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      background: #fab1a0;
      color: #2d3436;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      background: #fff;
      font-size: 13px;
      table-layout: fixed;
    }

    th, td {
      padding: 10px 12px;
      border: 1px solid #dfe6e9;
      vertical-align: top;
      word-wrap: break-word;
      white-space: normal;
      overflow-wrap: break-word;
      max-width: 180px;
      min-width: 100px;
    }

    th {
      background: #e67e22;
      color: #fff;
    }

    .country-select {
      position: relative;
      width: 120px;
    }

    .country-select input {
      width: 100%;
      padding: 7px 9px;
      border-radius: 6px;
      border: 1px solid #b2bec3;
      background: #fffdf8;
      cursor: default;
    }

    .country-options {
      position: absolute;
      top: 38px;
      left: 0;
      width: 100%;
      background: white;
      border: 1px solid #ccc;
      border-radius: 6px;
      max-height: 180px;
      overflow-y: auto;
      z-index: 1000;
      display: none;
    }

    .country-option {
      padding: 6px 10px;
      cursor: pointer;
      display: flex;
      gap: 6px;
      align-items: center;
    }

    .flag {
      font-size: 18px;
    }

    .modal-backdrop,
    .admin-modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }

    .modal,
    .admin-modal {
      background: #fff;
      padding: 20px 24px;
      border-radius: 10px;
      max-width: 320px;
      text-align: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }

    .modal button,
    .admin-modal button {
      margin-top: 12px;
      padding: 7px 16px;
      border-radius: 18px;
      border: none;
      background: #e17055;
      color: #fff;
      cursor: pointer;
      font-weight: 600;
    }

    .admin-modal input {
      width: 100%;
      margin-top: 8px;
      padding: 7px 9px;
      border-radius: 6px;
      border: 1px solid #b2bec3;
    }

    .disabled-field {
      background: #eee;
    }

    /* Edit modal */
    .edit-modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2100;
    }
    .edit-modal {
      background: #fff;
      padding: 16px 20px;
      border-radius: 10px;
      max-width: 600px;
      width: 100%;
      max-height: 80vh;
      overflow-y: auto;
    }
    .edit-modal h3 {
      margin-top: 0;
    }
    .edit-row {
      display: flex;
      gap: 10px;
      margin-bottom: 8px;
    }
    .edit-row > div {
      flex: 1;
    }
    .edit-modal label {
      display: block;
      font-size: 12px;
      margin-bottom: 2px;
    }
    .edit-modal input, .edit-modal select {
      width: 100%;
      padding: 5px 7px;
      border-radius: 6px;
      border: 1px solid #b2bec3;
    }
    .edit-modal-buttons {
      margin-top: 10px;
      text-align: right;
    }
    .edit-modal-buttons button {
      margin-left: 8px;
      padding: 6px 14px;
      border-radius: 18px;
      border: none;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
    }
    .edit-save-btn {
      background: #27ae60;
      color: #fff;
    }
    .edit-cancel-btn {
      background: #777;
      color: #fff;
    }
  </style>
</head>
<body>

<header>
  <h1>Perth Initiated Devotee List</h1>
  <div class="view-switch">
    <button id="adminViewBtn">Admin View</button>
    <button id="userViewBtn" class="active">User View</button>
  </div>
</header>

<main>

<div id="welcomeMessage" class="card" style="text-align:center; margin-bottom:20px;">
  <img src="iskcon-logo.png"
       alt="ISKCON Perth"
       style="display:block; margin:0 auto 10px; max-width:180px;">
  <h2 style="margin-bottom:0;">Welcome to ISKCON Perth</h2>
</div>

  <!-- ===================== ADMIN VIEW ===================== -->
  <div id="adminView" class="card hidden">
    <h2>Admin Dashboard</h2>

    <div class="admin-controls">
      <button id="deleteSelectedBtn">Delete Selected</button>
      <button id="exportAllCsvBtn">Export to .csv</button>
      <button id="exportAllXlsxBtn">Export to .xlsx</button>
      <button id="exportAllPdfBtn">Export to PDF</button>
    </div>

    <table id="devoteeTable">
      <thead>
        <tr>
          <th></th>
          <th>Edit</th>
          <th>First Name</th>
          <th>Last Name</th>
          <th>Full Name as per passport</th>
          <th>Email</th>
          <th>Gender</th>
          <th>DOB</th>
          <th>Passport</th>
          <th>Mobile</th>
          <th>Family Head</th>
          <th>Addr1</th>
          <th>Addr2</th>
          <th>City</th>
          <th>State</th>
          <th>Postcode</th>
          <th>Country</th>
          <th>Are Initiated</th>
          <th>Initiated Name</th>
          <th>Initiation Status</th>
          <th>Place of Initiation</th>
          <th>Initiation Date</th>
          <th>Siksha Guru / Mentor</th>
          <th>Diksha Guru</th>
          <th>Submission Date</th>
          <th>Last Updated</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
  <!-- ===================== USER VIEW ===================== -->
  <div id="userView" class="card">
    <h2>Dear Devotee, please fill the below details</h2>

    <form id="devoteeForm">

      <!-- PERSONAL DETAILS -->
      <div class="form-section-title">Personal Details</div>

      <div class="form-row">
        <div class="form-group">
          <label>First Name (as per passport) *</label>
          <input type="text" id="firstName">
          <div class="error" id="firstNameError"></div>
        </div>

        <div class="form-group">
          <label>Last Name (as per passport) *</label>
          <input type="text" id="lastName">
          <div class="error" id="lastNameError"></div>
        </div>

        <div class="form-group">
          <label>Full Name as per passport</label>
          <input type="text" id="fullName">
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Email Address *</label>
          <input type="email" id="email">
          <div class="error" id="emailError"></div>
        </div>

        <div class="form-group">
          <label>Gender</label>
          <select id="gender">
            <option value="">Select</option>
            <option>Male</option>
            <option>Female</option>
            <option>Other</option>
          </select>
        </div>

        <div class="form-group">
          <label>Date of Birth *</label>
          <input type="date" id="dob">
          <div class="error" id="dobError"></div>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Passport Number *</label>
          <input type="text" id="passportNumber">
          <div class="error" id="passportNumberError"></div>
        </div>

        <div class="form-group">
          <label>Mobile Number (Australia only) *</label>
          <div style="display:flex; gap:8px; align-items:center;">
            <div class="country-select">
              <input type="text" id="countryCodeInput" value="+61" readonly>
              <div class="country-options" id="countryOptions">
                <div class="country-option" data-code="+61">
                  <span class="flag">ðŸ‡¦ðŸ‡º</span> +61 Australia
                </div>
              </div>
            </div>
            <input type="text" id="mobileNumber" placeholder="04xx xxx xxx" style="width:140px;">
          </div>
          <div class="error" id="mobileError"></div>
        </div>
      </div>

      <div class="checkbox-group">
        <input type="checkbox" id="familyHead">
        <label for="familyHead">Are you family head?</label>
      </div>

      <!-- ADDRESS -->
      <div class="form-section-title">Current Address</div>

      <div class="form-row">
        <div class="form-group">
          <label>Address Line 1</label>
          <input type="text" id="addrLine1">
        </div>

        <div class="form-group">
          <label>Address Line 2</label>
          <input type="text" id="addrLine2">
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>City</label>
          <input type="text" id="city">
        </div>

        <div class="form-group">
          <label>State</label>
          <input type="text" id="state">
        </div>

        <div class="form-group">
          <label>Postcode</label>
          <input type="text" id="postcode">
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Country</label>
          <select id="country">
            <option value="Australia">ðŸ‡¦ðŸ‡º Australia</option>
          </select>
        </div>
      </div>

      <!-- INITIATION DETAILS -->
      <div class="form-section-title">Initiation Details</div>

      <div class="form-row">
        <div class="form-group">
          <label>Are you initiated?</label>
          <select id="areInitiated">
            <option value="">Select</option>
            <option>YES</option>
            <option>NO</option>
          </select>
        </div>

        <div class="form-group">
          <label>Initiated Name</label>
          <input type="text" id="initiatedName" class="init-field">
        </div>

        <div class="form-group">
          <label>Initiation Status</label>
          <select id="initiationStatus" class="init-field">
            <option value="">Select</option>
            <option>First</option>
            <option>Second</option>
            <option>No</option>
          </select>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Place of Initiation</label>
          <input type="text" id="placeOfInitiation" class="init-field">
        </div>

        <div class="form-group">
          <label>Date of Initiation</label>
          <input type="date" id="initiationDate" class="init-field">
        </div>

        <div class="form-group">
          <label>Siksha Guru / Mentor (optional)</label>
          <input type="text" id="shikshaGuru">
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Diksha Guru Name</label>
          <input type="text" id="dikshaGuru">
        </div>
      </div>

      <div class="submit-row">
        <button type="submit">Submit</button>
        <button type="button" id="resetBtn" style="background:#777;">Reset</button>
      </div>

    </form>
  </div>

</main>

<!-- SUCCESS MODAL -->
<div id="successModalBackdrop" class="modal-backdrop">
  <div class="modal">
    <h3>Submitted successfully</h3>
    <p>Thank you for entering your details.</p>
    <button id="successCloseBtn">Close</button>
  </div>
</div>

<!-- ADMIN LOGIN MODAL -->
<div id="adminModalBackdrop" class="admin-modal-backdrop">
  <div class="admin-modal">
    <h3>Admin Login</h3>
    <input type="password" id="adminPasswordInput" placeholder="Enter password">
    <div class="error" id="adminPasswordError"></div>
    <button id="adminLoginBtn">Login</button>
  </div>
</div>

<!-- EDIT MODAL -->
<div id="editModalBackdrop" class="edit-modal-backdrop">
  <div class="edit-modal">
    <h3>Edit Devotee</h3>
    <form id="editForm">
      <div class="edit-row">
        <div>
          <label>First Name</label>
          <input type="text" id="edit_firstName">
        </div>
        <div>
          <label>Last Name</label>
          <input type="text" id="edit_lastName">
        </div>
      </div>

      <div class="edit-row">
        <div>
          <label>Full Name as per passport</label>
          <input type="text" id="edit_fullName">
        </div>
        <div>
          <label>Email</label>
          <input type="email" id="edit_email">
        </div>
      </div>

      <div class="edit-row">
        <div>
          <label>Gender</label>
          <input type="text" id="edit_gender">
        </div>
        <div>
          <label>DOB</label>
          <input type="date" id="edit_dob">
        </div>
      </div>

      <div class="edit-row">
        <div>
          <label>Passport</label>
          <input type="text" id="edit_passport">
        </div>
        <div>
          <label>Mobile</label>
          <input type="text" id="edit_mobile">
        </div>
      </div>

      <div class="edit-row">
        <div>
          <label>Family Head</label>
          <input type="text" id="edit_familyHead">
        </div>
        <div>
          <label>Country</label>
          <input type="text" id="edit_country">
        </div>
      </div>

      <div class="edit-row">
        <div>
          <label>Address Line 1</label>
          <input type="text" id="edit_addrLine1">
        </div>
        <div>
          <label>Address Line 2</label>
          <input type="text" id="edit_addrLine2">
        </div>
      </div>

      <div class="edit-row">
        <div>
          <label>City</label>
          <input type="text" id="edit_city">
        </div>
        <div>
          <label>State</label>
          <input type="text" id="edit_state">
        </div>
        <div>
          <label>Postcode</label>
          <input type="text" id="edit_postcode">
        </div>
      </div>

      <div class="edit-row">
        <div>
          <label>Are Initiated</label>
          <input type="text" id="edit_areInitiated">
        </div>
        <div>
          <label>Initiated Name</label>
          <input type="text" id="edit_initiatedName">
        </div>
      </div>

      <div class="edit-row">
        <div>
          <label>Initiation Status</label>
          <input type="text" id="edit_initiationStatus">
        </div>
        <div>
          <label>Place of Initiation</label>
          <input type="text" id="edit_placeOfInitiation">
        </div>
      </div>

      <div class="edit-row">
        <div>
          <label>Initiation Date</label>
          <input type="date" id="edit_initiationDate">
        </div>
        <div>
          <label>Siksha Guru / Mentor</label>
          <input type="text" id="edit_shikshaGuru">
        </div>
        <div>
          <label>Diksha Guru</label>
          <input type="text" id="edit_dikshaGuru">
        </div>
      </div>

      <div class="edit-modal-buttons">
        <button type="button" class="edit-cancel-btn" id="editCancelBtn">Cancel</button>
        <button type="submit" class="edit-save-btn">Save</button>
      </div>
    </form>
  </div>
</div>

<script>
/* ============================================================
   FIREBASE INITIALIZATION
============================================================ */
const firebaseConfig = {
  apiKey: "AIzaSyDxJY7_VirTqoXMYbjjFzsHaAz-KSbQEj8",
  authDomain: "bhakti-vriksha-2e295.firebaseapp.com",
  databaseURL: "https://bhakti-vriksha-2e295-default-rtdb.firebaseio.com",
  projectId: "bhakti-vriksha-2e295",
  storageBucket: "bhakti-vriksha-2e295.appspot.com",
  messagingSenderId: "159402779568",
  appId: "1:159402779568:web:dc0c4a39a0c51d08dcac75",
  measurementId: "G-5LKYY6YZBC"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ============================================================
   UNIFIED APPLICATION LOGIC
============================================================ */
document.addEventListener("DOMContentLoaded", () => {

  /* ------------------------------------------------------------
     ELEMENT REFERENCES
  ------------------------------------------------------------ */
  const form = document.getElementById("devoteeForm");
  const resetBtn = document.getElementById("resetBtn");
  const successModalBackdrop = document.getElementById("successModalBackdrop");
  const successCloseBtn = document.getElementById("successCloseBtn");

  const adminBtn = document.getElementById("adminViewBtn");
  const userBtn = document.getElementById("userViewBtn");
  const adminView = document.getElementById("adminView");
  const userView = document.getElementById("userView");
  const welcomeMessage = document.getElementById("welcomeMessage");

  const adminModalBackdrop = document.getElementById("adminModalBackdrop");
  const adminPasswordInput = document.getElementById("adminPasswordInput");
  const adminPasswordError = document.getElementById("adminPasswordError");
  const adminLoginBtn = document.getElementById("adminLoginBtn");

  const deleteSelectedBtn = document.getElementById("deleteSelectedBtn");
  const exportAllCsvBtn = document.getElementById("exportAllCsvBtn");
  const exportAllXlsxBtn = document.getElementById("exportAllXlsxBtn");
  const exportAllPdfBtn = document.getElementById("exportAllPdfBtn");

  const countryCodeInput = document.getElementById("countryCodeInput");
  const countryOptions = document.getElementById("countryOptions");

  const ADMIN_PASSWORD = "Kalamunda";

  let devotees = [];
  let devoteesKeys = [];
  let currentEditKey = null;

  /* ------------------------------------------------------------
     COUNTRY CODE DROPDOWN (Australia only)
  ------------------------------------------------------------ */
  if (countryCodeInput && countryOptions) {
    countryCodeInput.onclick = () => {
      // Only Australia; no search needed
      countryOptions.style.display = "block";
    };

    document.addEventListener("click", (e) => {
      if (!countryCodeInput.contains(e.target) && !countryOptions.contains(e.target)) {
        countryOptions.style.display = "none";
      }
    });

    countryOptions.querySelectorAll(".country-option").forEach(opt => {
      opt.onclick = () => {
        countryCodeInput.value = opt.dataset.code;
        countryOptions.style.display = "none";
      };
    });
  }

  /* ------------------------------------------------------------
     MOBILE VALIDATION HELPERS
  ------------------------------------------------------------ */
  function formatAustralianMobile(num) {
    let digits = num.replace(/\D/g, "");
    if (digits.length === 9 && digits.startsWith("4")) digits = "0" + digits;
    if (!digits.startsWith("04")) return null;
    if (digits.length !== 10) return null;
    return digits.replace(/(\d{4})(\d{3})(\d{3})/, "$1 $2 $3");
  }

  /* ------------------------------------------------------------
     INITIATION FIELDS ENABLE/DISABLE
  ------------------------------------------------------------ */
  const areInitiatedEl = document.getElementById("areInitiated");
  const initFields = document.querySelectorAll(".init-field");

  function updateInitiationFields() {
    const val = (areInitiatedEl.value || "").toUpperCase();
    const disabled = (val === "NO");
    initFields.forEach(el => {
      el.disabled = disabled;
      if (disabled) {
        el.classList.add("disabled-field");
        el.value = "";
      } else {
        el.classList.remove("disabled-field");
      }
    });
  }

  areInitiatedEl.addEventListener("change", updateInitiationFields);
  updateInitiationFields();
  /* ------------------------------------------------------------
     FORM SUBMISSION
  ------------------------------------------------------------ */
  form.onsubmit = async (e) => {
    e.preventDefault();

    let valid = true;

    const required = [
      ["firstName", "First name is required"],
      ["lastName", "Last name is required"],
      ["dob", "Date of birth is required"],
      ["passportNumber", "Passport number is required"],
      ["email", "Email is required"]
    ];

    required.forEach(([id, msg]) => {
      const input = document.getElementById(id);
      const error = document.getElementById(id + "Error");
      if (!input.value.trim()) {
        if (error) error.textContent = msg;
        valid = false;
      } else {
        if (error) error.textContent = "";
      }
    });

    /* MOBILE VALIDATION */
    const mobileNumberEl = document.getElementById("mobileNumber");
    const mobileNumber = mobileNumberEl.value.trim();
    const mobileError = document.getElementById("mobileError");
    const countryCode = countryCodeInput.value.trim();

    if (!countryCode || !mobileNumber) {
      mobileError.textContent = "Mobile number with country code is required";
      valid = false;
    } else {
      const formatted = formatAustralianMobile(mobileNumber);
      if (!formatted) {
        mobileError.textContent = "Australian mobile must be 10 digits and start with 04";
        valid = false;
      } else {
        mobileNumberEl.value = formatted;
        mobileError.textContent = "";
      }
    }

    if (!valid) return;

    /* ------------------------------------------------------------
       FULL NAME AUTO-GENERATION
    ------------------------------------------------------------ */
    const first = document.getElementById("firstName").value.trim();
    const last = document.getElementById("lastName").value.trim();
    const fullNameInput = document.getElementById("fullName").value.trim();
    const fullName = fullNameInput || `${first} ${last}`.trim();

    /* ------------------------------------------------------------
       DATA OBJECT
    ------------------------------------------------------------ */
    const now = Date.now();

    const data = {
      firstName: first,
      lastName: last,
      fullName,
      email: document.getElementById("email").value.trim(),
      gender: document.getElementById("gender").value,
      dob: document.getElementById("dob").value,
      passport: document.getElementById("passportNumber").value.trim(),
      mobile: countryCode + " " + document.getElementById("mobileNumber").value.trim(),
      familyHead: document.getElementById("familyHead").checked ? "Yes" : "No",
      addrLine1: document.getElementById("addrLine1").value.trim(),
      addrLine2: document.getElementById("addrLine2").value.trim(),
      city: document.getElementById("city").value.trim(),
      state: document.getElementById("state").value.trim(),
      postcode: document.getElementById("postcode").value.trim(),
      country: document.getElementById("country").value,
      areInitiated: document.getElementById("areInitiated").value,
      initiatedName: document.getElementById("initiatedName").value.trim(),
      initiationStatus: document.getElementById("initiationStatus").value,
      placeOfInitiation: document.getElementById("placeOfInitiation").value.trim(),
      initiationDate: document.getElementById("initiationDate").value,
      shikshaGuru: document.getElementById("shikshaGuru").value.trim(),
      dikshaGuru: document.getElementById("dikshaGuru").value.trim(),
      submissionDate: now,
      lastUpdatedDate: now
    };

    /* ------------------------------------------------------------
       SAVE TO FIREBASE
    ------------------------------------------------------------ */
    try {
      const ref = db.ref("devotees").push();
      await ref.set(data);

      form.reset();
      countryCodeInput.value = "+61";
      document.querySelectorAll(".error").forEach(e => e.textContent = "");
      updateInitiationFields();

      successModalBackdrop.style.display = "flex";
    } catch (err) {
      alert("Error submitting details. Please try again.");
      console.error(err);
    }
  };

  /* ------------------------------------------------------------
     RESET BUTTON
  ------------------------------------------------------------ */
  resetBtn.onclick = () => {
    form.reset();
    countryCodeInput.value = "+61";
    document.querySelectorAll(".error").forEach(e => e.textContent = "");
    updateInitiationFields();
  };

  successCloseBtn.onclick = () => {
    successModalBackdrop.style.display = "none";
  };

  /* ------------------------------------------------------------
     ADMIN LOGIN
  ------------------------------------------------------------ */
  function showAdminModal() {
    adminPasswordInput.value = "";
    adminPasswordError.textContent = "";
    adminModalBackdrop.style.display = "flex";
    adminPasswordInput.focus();
  }

  function hideAdminModal() {
    adminModalBackdrop.style.display = "none";
  }

  adminBtn.onclick = () => showAdminModal();

  adminLoginBtn.onclick = () => {
    if (adminPasswordInput.value === ADMIN_PASSWORD) {
      hideAdminModal();
      adminView.classList.remove("hidden");
      userView.classList.add("hidden");
      if (welcomeMessage) welcomeMessage.style.display = "none";
      loadFromDatabase();
    } else {
      adminPasswordError.textContent = "Incorrect password.";
    }
  };

  userBtn.onclick = () => {
    adminView.classList.add("hidden");
    userView.classList.remove("hidden");
    if (welcomeMessage) welcomeMessage.style.display = "none";
  };

  /* ------------------------------------------------------------
     LOAD DATA FOR ADMIN TABLE
  ------------------------------------------------------------ */
  function loadFromDatabase() {
    db.ref("devotees").once("value", (snapshot) => {
      devotees = [];
      devoteesKeys = [];
      snapshot.forEach(child => {
        devoteesKeys.push(child.key);
        devotees.push(child.val());
      });
      renderTable();
    });
  }

  /* ------------------------------------------------------------
     FORMAT DOB (DD-MMM-YYYY) & TIMESTAMP
  ------------------------------------------------------------ */
  function formatDOB(dateStr) {
    if (!dateStr) return "";
    const parts = dateStr.split("-");
    if (parts.length !== 3) return dateStr;
    const [yyyy, mm, dd] = parts;
    const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
    const mIndex = parseInt(mm, 10) - 1;
    if (isNaN(mIndex) || mIndex < 0 || mIndex > 11) return dateStr;
    return `${dd}-${months[mIndex]}-${yyyy}`;
  }

function formatTimestamp(ts) {
  if (!ts) return "";
  const d = new Date(ts);
  const dd = String(d.getDate()).padStart(2, "0");
  const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
  const mmm = months[d.getMonth()];
  const yyyy = d.getFullYear();
  return `${dd}-${mmm}-${yyyy}`;
}


  /* ------------------------------------------------------------
     RENDER ADMIN TABLE
  ------------------------------------------------------------ */
  function renderTable() {
    const tbody = document.querySelector("#devoteeTable tbody");
    tbody.innerHTML = "";

    devotees.forEach((d, index) => {
      const row = document.createElement("tr");

      const checkboxTd = document.createElement("td");
      checkboxTd.innerHTML = `<input type="checkbox" class="row-select" data-index="${index}">`;
      row.appendChild(checkboxTd);

      const editTd = document.createElement("td");
      const editBtn = document.createElement("button");
      editBtn.textContent = "Edit";
      editBtn.style.padding = "4px 8px";
      editBtn.style.borderRadius = "12px";
      editBtn.style.border = "none";
      editBtn.style.background = "#74b9ff";
      editBtn.style.color = "#fff";
      editBtn.style.cursor = "pointer";
      editBtn.onclick = () => openEditModal(index);
      editTd.appendChild(editBtn);
      row.appendChild(editTd);

      const cells = [
        d.firstName || "",
        d.lastName || "",
        d.fullName || "",
        d.email || "",
        d.gender || "",
        formatDOB(d.dob || ""),
        d.passport || "",
        d.mobile || "",
        d.familyHead || "",
        d.addrLine1 || "",
        d.addrLine2 || "",
        d.city || "",
        d.state || "",
        d.postcode || "",
        d.country || "",
        d.areInitiated || "",
        d.initiatedName || "",
        d.initiationStatus || "",
        d.placeOfInitiation || "",
        formatDOB(d.initiationDate || ""),
        d.shikshaGuru || "",
        d.dikshaGuru || "",
        formatTimestamp(d.submissionDate),
        formatTimestamp(d.lastUpdatedDate)
      ];

      cells.forEach(val => {
        const td = document.createElement("td");
        td.textContent = val;
        row.appendChild(td);
      });

      tbody.appendChild(row);
    });
  }
  /* ------------------------------------------------------------
     DELETE SELECTED
  ------------------------------------------------------------ */
  deleteSelectedBtn.onclick = () => {
    const checkboxes = document.querySelectorAll(".row-select:checked");
    const indexes = [...checkboxes].map(cb => parseInt(cb.dataset.index));

    const toDelete = indexes.map(i => devoteesKeys[i]).filter(k => k);

    toDelete.forEach(key => {
      db.ref("devotees/" + key).remove();
    });

    setTimeout(() => loadFromDatabase(), 500);
  };

  /* ------------------------------------------------------------
     EDIT MODAL LOGIC
  ------------------------------------------------------------ */
  const editModalBackdrop = document.getElementById("editModalBackdrop");
  const editForm = document.getElementById("editForm");
  const editCancelBtn = document.getElementById("editCancelBtn");

  function openEditModal(index) {
    const d = devotees[index];
    currentEditKey = devoteesKeys[index];

    document.getElementById("edit_firstName").value = d.firstName || "";
    document.getElementById("edit_lastName").value = d.lastName || "";
    document.getElementById("edit_fullName").value = d.fullName || "";
    document.getElementById("edit_email").value = d.email || "";
    document.getElementById("edit_gender").value = d.gender || "";
    document.getElementById("edit_dob").value = d.dob || "";
    document.getElementById("edit_passport").value = d.passport || "";
    document.getElementById("edit_mobile").value = d.mobile || "";
    document.getElementById("edit_familyHead").value = d.familyHead || "";
    document.getElementById("edit_country").value = d.country || "";
    document.getElementById("edit_addrLine1").value = d.addrLine1 || "";
    document.getElementById("edit_addrLine2").value = d.addrLine2 || "";
    document.getElementById("edit_city").value = d.city || "";
    document.getElementById("edit_state").value = d.state || "";
    document.getElementById("edit_postcode").value = d.postcode || "";
    document.getElementById("edit_areInitiated").value = d.areInitiated || "";
    document.getElementById("edit_initiatedName").value = d.initiatedName || "";
    document.getElementById("edit_initiationStatus").value = d.initiationStatus || "";
    document.getElementById("edit_placeOfInitiation").value = d.placeOfInitiation || "";
    document.getElementById("edit_initiationDate").value = d.initiationDate || "";
    document.getElementById("edit_shikshaGuru").value = d.shikshaGuru || "";
    document.getElementById("edit_dikshaGuru").value = d.dikshaGuru || "";

    editModalBackdrop.style.display = "flex";
  }

  editCancelBtn.onclick = () => {
    editModalBackdrop.style.display = "none";
    currentEditKey = null;
  };

  editForm.addEventListener("submit", (e) => {
    e.preventDefault();
    if (!currentEditKey) return;

    const updated = {
      firstName: document.getElementById("edit_firstName").value.trim(),
      lastName: document.getElementById("edit_lastName").value.trim(),
      fullName: document.getElementById("edit_fullName").value.trim(),
      email: document.getElementById("edit_email").value.trim(),
      gender: document.getElementById("edit_gender").value.trim(),
      dob: document.getElementById("edit_dob").value,
      passport: document.getElementById("edit_passport").value.trim(),
      mobile: document.getElementById("edit_mobile").value.trim(),
      familyHead: document.getElementById("edit_familyHead").value.trim(),
      country: document.getElementById("edit_country").value.trim(),
      addrLine1: document.getElementById("edit_addrLine1").value.trim(),
      addrLine2: document.getElementById("edit_addrLine2").value.trim(),
      city: document.getElementById("edit_city").value.trim(),
      state: document.getElementById("edit_state").value.trim(),
      postcode: document.getElementById("edit_postcode").value.trim(),
      areInitiated: document.getElementById("edit_areInitiated").value.trim(),
      initiatedName: document.getElementById("edit_initiatedName").value.trim(),
      initiationStatus: document.getElementById("edit_initiationStatus").value.trim(),
      placeOfInitiation: document.getElementById("edit_placeOfInitiation").value.trim(),
      initiationDate: document.getElementById("edit_initiationDate").value,
      shikshaGuru: document.getElementById("edit_shikshaGuru").value.trim(),
      dikshaGuru: document.getElementById("edit_dikshaGuru").value.trim(),
      lastUpdatedDate: Date.now()
    };

    db.ref("devotees/" + currentEditKey).update(updated)
      .then(() => {
        editModalBackdrop.style.display = "none";
        currentEditKey = null;
        loadFromDatabase();
      })
      .catch(err => console.error(err));
  });

  /* ------------------------------------------------------------
     EXPORT FUNCTIONS
  ------------------------------------------------------------ */

  const exportFields = [
    "firstName", "lastName", "fullName", "email", "gender", "dob", "passport", "mobile", "familyHead",
    "addrLine1", "addrLine2", "city", "state", "postcode", "country",
    "areInitiated", "initiatedName", "initiationStatus", "placeOfInitiation", "initiationDate",
    "shikshaGuru", "dikshaGuru", "submissionDate", "lastUpdatedDate"
  ];

  // Export to CSV
  function exportCSV(rows) {
    const header = exportFields.join(",");

    const csvRows = rows.map(r => {
      const obj = {};
      exportFields.forEach(f => {
        if (f === "dob" || f === "initiationDate") {
          obj[f] = formatDOB(r[f] || "");
        } else if (f === "submissionDate" || f === "lastUpdatedDate") {
          obj[f] = formatTimestamp(r[f]);
        } else {
          obj[f] = r[f] || "";
        }
      });
      return exportFields.map(f => `"${String(obj[f]).replace(/"/g, '""')}"`).join(",");
    });

    const csv = [header, ...csvRows].join("\n");

    const blob = new Blob([csv], { type: "text/csv" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "devotees.csv";
    a.click();
  }

  // Export to Excel
  function exportExcel(rows) {
    const formatted = rows.map(r => {
      const obj = {};
      exportFields.forEach(f => {
        if (f === "dob" || f === "initiationDate") {
          obj[f] = formatDOB(r[f] || "");
        } else if (f === "submissionDate" || f === "lastUpdatedDate") {
          obj[f] = formatTimestamp(r[f]);
        } else {
          obj[f] = r[f] || "";
        }
      });
      return obj;
    });

    const ws = XLSX.utils.json_to_sheet(formatted, { header: exportFields });
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Devotees");
    XLSX.writeFile(wb, "devotees.xlsx");
  }

  /* ------------------------------------------------------------
     PDF EXPORT â€” WITH BOLD GURU NAMES + DEVOTIONAL FOOTER
  ------------------------------------------------------------ */
  function exportPDF(rows) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF("landscape");

    const margin = 10;
    const rowHeight = 8;

    /* -----------------------------
       TABLE 1: PERSONAL DETAILS
    ----------------------------- */

    const headers1 = [
      "First Name", "Last Name", "Full Name",
      "Email", "Gender", "DOB", "Passport", "Mobile",
      "Family Head", "Address 1", "Address 2",
      "City", "State", "Postcode", "Country"
    ];

    const fields1 = [
      "firstName", "lastName", "fullName",
      "email", "gender", "dob", "passport", "mobile",
      "familyHead", "addrLine1", "addrLine2",
      "city", "state", "postcode", "country"
    ];

    let colWidth1 = 35;
    let y = 20;

    // Title
    doc.setFont("helvetica", "bold");
    doc.setFontSize(14);
    doc.text("Devotee List - Personal Details", margin, 12);

    // Header row
    doc.setFontSize(9);
    doc.setFont("helvetica", "bold");

    let x = margin;
    headers1.forEach(h => {
      doc.text(h, x, y);
      x += colWidth1;
    });

    y += rowHeight;

    // Data rows
    doc.setFont("helvetica", "normal");
    doc.setTextColor(0, 0, 0);

    rows.forEach(r => {
      x = margin;
      fields1.forEach(f => {
        let value = r[f] || "";
        if (f === "dob") value = formatDOB(r[f] || "");
        doc.text(String(value), x, y);
        x += colWidth1;
      });
      y += rowHeight;

      if (y > 190) {
        addFooter(doc);
        doc.addPage();
        y = 20;
      }
    });

    addFooter(doc);

    /* -----------------------------
       TABLE 2: SPIRITUAL DETAILS
    ----------------------------- */

    doc.addPage();
    y = 20;

    const headers2 = [
      "Full Name",
      "Are Initiated",
      "Initiated Name",
      "Initiation Status",
      "Place of Initiation",
      "Initiation Date",
      "Siksha Guru / Mentor",
      "Diksha Guru",
      "Submission Date",
      "Last Updated"
    ];

    const fields2 = [
      "fullName",
      "areInitiated",
      "initiatedName",
      "initiationStatus",
      "placeOfInitiation",
      "initiationDate",
      "shikshaGuru",
      "dikshaGuru",
      "submissionDate",
      "lastUpdatedDate"
    ];

    let colWidth2 = 40;

    // Title
    doc.setFont("helvetica", "bold");
    doc.setFontSize(14);
    doc.text("Devotee List - Spiritual Details", margin, 12);

    // Header row
    doc.setFontSize(9);
    doc.setFont("helvetica", "bold");
    doc.setTextColor(0, 0, 0);

    x = margin;
    headers2.forEach(h => {
      doc.text(h, x, y);
      x += colWidth2;
    });

    y += rowHeight;

    // Data rows
    rows.forEach(r => {
      x = margin;

      fields2.forEach(f => {
        let value = r[f] || "";

        if (f === "initiationDate") {
          value = formatDOB(r[f] || "");
        } else if (f === "submissionDate" || f === "lastUpdatedDate") {
          value = formatTimestamp(r[f]);
        }

        if (f === "shikshaGuru") {
          doc.setFont("helvetica", "bold");
          doc.setTextColor(0, 0, 0);
        } else if (f === "dikshaGuru") {
          doc.setFont("helvetica", "bold");
          doc.setTextColor(255, 102, 0); // saffron
        } else {
          doc.setFont("helvetica", "normal");
          doc.setTextColor(0, 0, 0);
        }

        doc.text(String(value), x, y);
        x += colWidth2;
      });

      y += rowHeight;

      if (y > 190) {
        addFooter(doc);
        doc.addPage();
        y = 20;
      }
    });

    addFooter(doc);

    doc.save("devotees.pdf");
  }

  function addFooter(doc) {
    doc.setFont("helvetica", "italic");
    doc.setFontSize(10);
    doc.setTextColor(0, 0, 0);
    doc.text("Hare Krishna.. All glories to guru and Gaurango", 10, 200);
  }

  /* ------------------------------------------------------------
     EXPORT BUTTONS
  ------------------------------------------------------------ */
  exportAllCsvBtn.onclick = () => exportCSV(devotees);
  exportAllXlsxBtn.onclick = () => exportExcel(devotees);
  exportAllPdfBtn.onclick = () => exportPDF(devotees);

});
</script>
</body>
</html>


